<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Go Study App: Mainpage</title>
</head>
<body>
    <div id="MainTitle" class="pageHeader">
        <h2>Go Study App</h2>
        <div id="ToolTipController">
            <input type="checkbox" id="ToolTipCheck" checked value="tooltip" onchange="toolTipChange(this)" /><label for="ToolTipCheck">Tooltips</label>
        </div>
    </div>
    <div id="InfoWidget">
        <span id="InfoDisplay"></span>
    </div>
    <br />
    <div id="ProverbWidget">
        <h4>Remember:</h4>
        <span id="currProverb"></span>
        <br />
        <button id="provNext" onclick="nextProverb()">next</button>
        <button id="provSearch">search</button>
    </div>
    <br />
    <div id="NotesWidget">
        <h4>Personal Notes for Study</h4>
        <table id="NoteTable"></table>
        <form type="text" id="newNote">
            <label>New Note</label>
            <span><input type="text" id="noteInput"></input></span><button type="button" id="saveCurNote" onclick="saveNote()">Add</button>
        </form>

        <br /><button id="saveNotes" onclick="saveToFile()" hidden="true">Save Session</button>
        <button id="loadNotes" onclick="loadFromFile()" hidden="true">Load Session</button>
    </div>
    <br />
    <div id="NewsWidget">
        <h4>Latest Go News (from the AGA)</h4>
        <span id="currNews"></span>
        <br />

        <button id="newsNext" onclick="nextNews()">next</button>
        <button id="loadSgfNews" onclick="loadNewsSgf()" hidden="true">Load News .sgf</button>
    </div>
    <br />
    <div id="JosekiWidget">
        <!--The following is the open source eidogo-player open source application.  It is from http://eidogo.com/source-->
        <script type="text/javascript" src="eidogo-player-1.2/player/js/all.compressed.js"></script>
        <div class="eidogo-player-auto" id="GoBoard" sgf="SaveData/alaska-beefstew.sgf">
        </div>
    </div>
    <script type="text/javascript">//Written by Stew Towle
        //Contains the script for operating the Go Study App main-page

        document.addEventListener("DOMContentLoaded", initialize);


        //----------Global Variables-----------------
        const sgfFile = "SaveData/alaska-beefstew.sgf";

        const toolTips = {
            ProverbWidget: "This widget displays proverbs you have saved to your personal proverbs and lessons.",
            JosekiWidget: "Interactive Go Board for playing out common sequences and saving notes about them",
            NotesWidget: "Use this area to view and edit Notes you have about Go.",
            NewsWidget: "This area displays the headlines of recent articles from the American Go Association with a link to the article."
        };

        //This is the fileData object.  It is not a constant since it is always changing
        //I still dont really get the const vs var vs let thing.
        //It will be overwritten but need to have the correct filePath here so that it knows where to get
        //The stuff it is overwritten with.
        let fileData = {
            proverbs: [
                "Use early game influence to attack",
                "When no move looks good, tenuki.",
                "Inside your territory make solid connection, facing out make tiger's mouth."
            ],
            currProv: 0,
            activeProvSearch: false,
            notes: {

            },
            joseki: {

            },
            notes: {

            },
            filePath: "SaveData/localSave.json"
        };

        //newsData object has data (storing the actual info), currIndex, activeSearch (boolean)
        //news stories in format array of arrays, each array is a news item.
        //sub-array is two to four parts, first element is headline, second is url, third is optional article content
        // and final is associated .sgf file as json style object
        const newsData = {
            data: [
                ["Go Seigen is the original AlphaGo", "http://www.usgo.org", "There isn't much more to say than the title.  Go Seigen was using moves that AI would later use over 70 years before AI became stronger than humans"],
                ["Blood vomit game is still being talked about", "http://www.go4go.net", "This is a famous game during which one of the players vomitted blood.",
                    "(;FF[4]PB[Hinaya Rippo]HA[5]PW[Honinbo Dosaku]KM[0]RE[W+R]AB[dd][dp][jj][pd][pp]; W[qf]; B[mc]; W[qn]; B[ql]; W[on]; B[rp]; W[cn]; B[gq]; W[cf]; B[ch]; W[ef]; B[bd]; W[cj]; B[bf]; W[ce]; B[be]; W[cg]; B[bg]; W[cd]; B[cc]; W[dc]; B[ed]; W[ec]; B[fc]; W[cb]; B[bc]; W[fd]; B[fe]; W[gd]; B[ee]; W[gc]; B[fb]; W[eb]; B[dh]; W[ge]; B[ff]; W[eg]; B[gf]; W[eh]; B[he]; W[gb]; B[ei]; W[gh]; B[fi]; W[gg]; B[if]; W[jh]; B[hj]; W[hg]; B[hf]; W[kg]; B[ke]; W[bi]; B[bh]; W[dj]; B[bb]; W[kj]; B[kk]; W[lj]; B[lk]; W[jk]; B[jl]; W[ik]; B[ij]; W[il]; B[ki]; W[li]; B[kh]; W[lh]; B[ji]; W[jg]; B[lg]; W[lf]; B[mg]; W[je]; B[jf]; W[kf]; B[jd]; W[kd]; B[le]; W[ng]; B[mh]; W[ni]; B[nh]; W[oh]; B[og]; W[ld]; B[nf]; W[me]; B[nj]; W[jm]; B[qd]; W[qj]; B[np]; W[ro]; B[qp]; W[pg]; B[pk]; W[oj]; B[ok]; W[mi]; B[pj]; W[oi]; B[qi]; W[pi]; B[qh]; W[ph]; B[mn]; W[mk]; B[nm]; W[nl]; B[qk]; W[fk]; B[ek]; W[fl]; B[ej]; W[cp]; B[hi]; W[hh]; B[cl]; W[bl]; B[dn]; W[dm]; B[el]; W[do]; B[en]; W[eo]; B[fn]; W[cm]; B[hl]; W[hk]; B[gk]; W[kl]; B[im]; W[ll]; B[gl]; W[gp]; B[fo]; W[fp]; B[ep]; W[co]; B[fq]; W[hp]; B[hq]; W[ip]; B[jq]; W[om]; B[ol]; W[mo])"]
            ],
            currIndex: 0,
            activeSearch: false
        };

        //const FILEPATH = "localSave.json";



        //--------------Utility Functions---------------

        //Loads tooltips to elements based on the passed object (which should be the global toolTips)
        function loadToolTips(tipsById) {
            for (const part in tipsById) {
                console.log(part);
                let curr_block = document.getElementById(part);
                curr_block.setAttribute("class", "tooltip");
                let tooltip = document.createElement("span");
                tooltip.innerText = tipsById[part];
                tooltip.setAttribute("class", "tooltiptext");
                curr_block.append(tooltip);
            }
        }

        function toolTipChange(checkboxEl) {
            if (checkboxEl.checked) {
                for (const part in toolTips) {
                    console.log(part);
                    let curr_block = document.getElementById(part);
                    curr_block.setAttribute("class", "tooltip");
                    let tooltip = document.createElement("span");
                    tooltip.innerText = toolTips[part];
                    tooltip.setAttribute("class", "tooltiptext");
                    curr_block.append(tooltip);
                }
                //document.getElementsByTagName("tooltiptext").style.visibiltiy = ".tooltip: hover.tooltiptext {visibility: visible;}";
            }
            else {
                for (const part in toolTips) {
                    console.log(part);
                    let curr_block = document.getElementById(part);
                    curr_block.setAttribute("class", "");
                    let tooltip = curr_block.getElementsByClassName("tooltiptext")[0];
                    tooltip.remove();
                    
                    //curr_block.append(tooltip);
                }
                //document.getElementsByTagName("body").style += ".tooltip: hover.tooltiptext {visibility: hidden;}";

            }
        }

        function loadJoseki(filePath) {
            let josekiDiv = document.querySelector("eidogo-player-auto");


        }

        function initProverbs(source) {
            let curr_index = Math.floor(Math.random() * source.proverbs.length);
            let span = document.getElementById("currProverb");
            span.innerText = source.proverbs[curr_index];
            source.proverbs.currProv = curr_index;
        }

        function nextProverb(source = fileData) {
            let span = document.getElementById("currProverb");
            if (!source.activeProvSearch) {
                //console.log(source.currProv);
                source.currProv++;
                //console.log(source.currProv);
                source.currProv = source.currProv % source.proverbs.length;
                //console.log(source.currProv);
                span.innerText = source.proverbs[source.currProv];
            }

        }

        function initNews(source = fileData) {
            let curr_index = Math.floor(Math.random() * source.data.length);
            source.currIndex = curr_index;
            nextNews();

        }

        function saveNote() {
            let note = document.getElementById("noteInput");
            console.log(note.value);
            fileData.notes.push(note.value);
            note.value = "";
            let notesDisplay = document.getElementById("NoteTable");
            let newNote = fileData.notes[fileData.notes.length - 1];
            notesDisplay.append(addNoteRow(newNote, fileData.notes.length - 1));
            saveToFile();

        }

        function nextNews(source = newsData) {
            source.currIndex = (source.currIndex + 1) % source.data.length;
            let curr_index = source.currIndex;
            let span = document.getElementById("currNews");
            span.innerText = source.data[curr_index][0];
            let link = document.createElement("a");
            link.href = source.data[curr_index][1];
            link.innerText = "Go to original article.";
            span.append(document.createElement("br"));
            span.append(link);
            if (source.data[curr_index].length > 3) {
                document.getElementById("loadSgfNews").hidden = true;//change this to true to renable loadNewsSgf
            }
            else {
                document.getElementById("loadSgfNews").hidden = true;
            }
            source.currIndex = curr_index;
        }

        /*This function is unnecessary for my project, I need to not do it.
        function loadNewsSgf(source = newsData) {
            let goboard = document.getElementById("GoBoard");
            console.log(goboard);
            goboard.innerHTML = source.data[source.currIndex][3];
        }
        */

        function loadNewsSgf() {
            alert("This functionality is not yet available.");
        }


        function displayToInfoBox(text) {
            document.getElementById("InfoDisplay").innerText = text;
        }

        //Given a json formatted data and file path saves the data to the file.
        function saveToFile(source = fileData) {
            let stringedData = JSON.stringify(source);
            //alert("Your data file is loading, please wait until file-loaded displays at the top of the app before using features");
            let request = new XMLHttpRequest();
            console.log('posting ' + stringedData);
            request.open('POST', '/save');
            request.setRequestHeader("Content-Type", "application/json");
            request.send(stringedData);
        }

        function addNoteRow(note, noteNum) {
            let newRow = document.createElement("tr");
            let noteCol = document.createElement("tc");
            noteCol.innerText = note;
            newRow.setAttribute("id", "note" + noteNum);
            let editCol = document.createElement("tc");
            let delCol = document.createElement("tc");
            editCol.innerHTML = '<button class="edit" type="button">edit</button>';
            editCol.firstChild.addEventListener('click', editRow);
            delCol.innerHTML = '<button class="del" type="button">delete</button>';
            delCol.firstChild.addEventListener('click', delRow);
            newRow.append(noteCol);
            newRow.append(editCol);
            newRow.append(delCol);
            //notesDisplay.append(newRow);
            return newRow;
        }

        function delRow(event) {
            //console.log("del", event);
            let decision = confirm("Are you sure you want to delete: " + event.srcElement.parentNode.parentNode.firstChild.innerText);
            if (decision) {
                let noteRow = event.srcElement.parentNode.parentNode;
                let elId = noteRow.id;
                let index = elId.lastIndexOf("e") + 1;
                let noteNumber = elId.slice(index);
                index = parseInt(noteNumber);
                console.log("deleting note ", index);
                fileData.notes.splice(index, 1);
                noteRow.remove();
                saveToFile();
            }
        }

        function editRow(event) {

            console.log(event.srcElement.parentNode.parentNode.id);//this is the note
        }
        //

        async function loadFromFile(source = fileData) {
            //let xm = new XMLHttpRequest();
            console.log("loading data");

            let content = {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(source)
            };

            const result = await fetch('/load', content);
            //console.log("result ", result.json());
            let obj_res = result.json();
            //console.log("obj made it back", obj_res);
            return obj_res;
            //fileData = JSON.parse(result.body);
            /*
            xm.open('POST', '/load');
            xm.onLoad(function () {

                    fileData = JSON.parse(xm.responseText);
                    //console.log(xm.responseText, "putting in fileData");

            });
            xm.setRequestHeader("Content-Type", "application/json");
            xm.send(JSON.stringify(source));
            */
        }


        function initNotes(source = fileData) {
            let notesDisplay = document.getElementById("NoteTable");
            for (note in source.notes) {
                notesDisplay.append(addNoteRow(source.notes[note], note));
            }
        }


        //----------------Initializing App--------------------

        async function initialize() {

            fileData = await loadFromFile().then(data => {
                return data;
            });
            loadToolTips(toolTips);
            //loadJoseki(sgfFile);
            initProverbs(fileData);
            initNews(newsData);
            initNotes(fileData);

        }</script>

    <!--The following code for tooltips is based on (and copied from) https://www.w3schools.com/css/css_tooltip.asp-->
    <style>
        .tooltip {
            position: relative;
            display: inline-block;
            /*border-bottom: 1px dotted black; THis puts dotted line under tooltipped object*/
        }

            .tooltip .tooltiptext {
                visibility: hidden;
                width: 120px;
                background-color: black;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px 0;
                /* Position the tooltip */
                position: absolute;
                z-index: 1;
                top: -5px;
                left: 105%;
            }

            .tooltip:hover .tooltiptext {
                visibility: visible;
            }
    </style>

</body>
</html>